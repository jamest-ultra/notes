Absolutely — here’s a **detailed implementation plan** you can store alongside your Jira ticket, Notion page, or codebase TODO doc to guide your future self step-by-step.

---

## 🛠️ **Implementation Plan: Symfony Test API Controllers for Cypress**

---

### 🔧 **1. Set Up Directory & Naming Convention**

* Controllers should live in:

  ```
  src/Controller/Test/
  ```
* Name format:

  ```
  {EntityName}TestApiController.php
  ```

  Example:

  * `CompanyTestApiController.php`
  * `DeviceTestApiController.php`

---

### 🧱 **2. Base Structure of Each Controller**

Use this base pattern for all controllers:

```php
#[Route('/api/test/{entity}', name: 'api_test_{entity}_create', methods: ['POST'])]
public function create(Request $request): JsonResponse {
    if ($_ENV['APP_ENV'] !== 'test') {
        return new JsonResponse(['error' => 'Forbidden'], 403);
    }

    $data = json_decode($request->getContent(), true);
    $entity = EntityFactory::createOne($data)->object();

    return new JsonResponse(['id' => $entity->getId()]);
}

#[Route('/api/test/{entity}/{id}', name: 'api_test_{entity}_delete', methods: ['DELETE'])]
public function delete(int $id): JsonResponse {
    if ($_ENV['APP_ENV'] !== 'test') {
        return new JsonResponse(['error' => 'Forbidden'], 403);
    }

    $entity = $this->em->getRepository(EntityClass::class)->find($id);
    if (!$entity) {
        return new JsonResponse(['error' => 'Not found'], 404);
    }

    $this->em->remove($entity);
    $this->em->flush();

    return new JsonResponse(null, 204);
}
```

---

### 🧩 **3. Inject Dependencies in Constructor**

For example:

```php
public function __construct(
    private EntityManagerInterface $em,
    private CompanyRepository $companyRepo,
    private TypeRepository $typeRepo,
    ...
) {}
```

Only inject what you need per entity — for basic cases, only `EntityManagerInterface` is sufficient.

---

### 🏗️ **4. Use Foundry Factories**

Use factories from:

```
App\Tests\Factory\App\Entity\Classic\
```

Each controller should call the appropriate factory using `createOne()`:

```php
$device = DeviceFactory::createOne([
    'company' => $this->companyRepo->findOneBy(['name' => $data['company']]),
    'imei' => $data['imei'] ?? null,
    ...
])->object();
```

Tip: Guard against missing required fields with helpful errors.

---

### 🔒 **5. Restrict Routes to APP\_ENV=test**

All test controllers must include a safeguard:

```php
if ($_ENV['APP_ENV'] !== 'test') {
    return new JsonResponse(['error' => 'Forbidden'], 403);
}
```

You can abstract this later with a helper trait if reused often.

---

### 🔄 **6. Standardize Responses**

Success:

```json
{ "id": 1234 }
```

Failure (e.g. invalid JSON, missing field):

```json
{ "error": "Missing 'company' field" }
```

Deletion:

* HTTP 204 or 200 with `{}` or no body

---

### 🔄 **7. Cypress Integration**

Once controllers exist, hook them up to Cypress like this:

```js
Cypress.Commands.add('apiCreateDevice', (data) => {
  cy.request('POST', '/api/test/devices', data).then((res) => {
    expect(res.status).to.eq(200)
    Cypress.env('createdDeviceId', res.body.id)
  });
});

Cypress.Commands.add('apiDeleteDevice', () => {
  const id = Cypress.env('createdDeviceId')
  cy.request('DELETE', `/api/test/devices/${id}`);
});
```

---

### 🧪 **8. Optional: Centralize Helpers**

If you end up duplicating this logic across many controllers:

* Create a base trait or abstract controller: `TestApiHelperTrait`

  * Guard `APP_ENV=test`
  * Decode JSON with error fallback
  * Return standardized JSON error/response
  * Validate required fields

---

### 📦 **9. Entities To Cover First**

* Company
* Contacts
* Device
* Driver
* Fob
* Group
* Personnel
* Vehicle

---

### 📌 **TODO Reminder Checklist**

* [ ] Create directory: `src/Controller/Test/`
* [ ] Set up routing via PHP 8 attributes
* [ ] Create controller per entity with POST and DELETE endpoints
* [ ] Inject repositories needed by each factory
* [ ] Use factories to create test entities
* [ ] Return created `id` in response
* [ ] Restrict to `APP_ENV=test`
* [ ] Hook into Cypress commands
* [ ] Optional: Refactor helpers into a trait later

---
